<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Make Rabbitmq Openshift Operator | 打工人，冲冲冲！！！</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="制作 rabbitmq openshift operator  以 rabbitmq-operator github 官方项目为基础 https://github.com/rabbitmq/cluster-operator  命令行工具  kustomize   下载地址
 operator-sdk   下载地址
 opm   下载地址
 制作过程  本文档以 rabbitmq 1.6.0 为基础制作 operator，link   下载源码  从官方 releases 页面下载 1.6.0 源码 解压后改名为 rabbitmq-operator  修改部分源码  删除 rabbitmq-operator/.github 目录，此目录是官方 github action 部分的代码，对其他项目无用（也可以不删除） 在 rabbitmq-operator/internal/resource 目录新建 anyuid_role_binding.go 文件，将下面代码复制到文件中，代码是根据 role_binding.go 文件修改来的，目的是解决 openshift scc 权限问题  // RabbitMQ Cluster Operator // // Copyright 2020 VMware, Inc."><meta name=generator content="Hugo 0.82.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><meta property="og:title" content="Make Rabbitmq Openshift Operator"><meta property="og:description" content="制作 rabbitmq openshift operator  以 rabbitmq-operator github 官方项目为基础 https://github.com/rabbitmq/cluster-operator  命令行工具  kustomize   下载地址
 operator-sdk   下载地址
 opm   下载地址
 制作过程  本文档以 rabbitmq 1.6.0 为基础制作 operator，link   下载源码  从官方 releases 页面下载 1.6.0 源码 解压后改名为 rabbitmq-operator  修改部分源码  删除 rabbitmq-operator/.github 目录，此目录是官方 github action 部分的代码，对其他项目无用（也可以不删除） 在 rabbitmq-operator/internal/resource 目录新建 anyuid_role_binding.go 文件，将下面代码复制到文件中，代码是根据 role_binding.go 文件修改来的，目的是解决 openshift scc 权限问题  // RabbitMQ Cluster Operator // // Copyright 2020 VMware, Inc."><meta property="og:type" content="article"><meta property="og:url" content="https://www.changkunkun.cn/posts/make-rabbitmq-openshift-operator/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-20T09:24:32+08:00"><meta property="article:modified_time" content="2021-04-20T09:24:32+08:00"><meta itemprop=name content="Make Rabbitmq Openshift Operator"><meta itemprop=description content="制作 rabbitmq openshift operator  以 rabbitmq-operator github 官方项目为基础 https://github.com/rabbitmq/cluster-operator  命令行工具  kustomize   下载地址
 operator-sdk   下载地址
 opm   下载地址
 制作过程  本文档以 rabbitmq 1.6.0 为基础制作 operator，link   下载源码  从官方 releases 页面下载 1.6.0 源码 解压后改名为 rabbitmq-operator  修改部分源码  删除 rabbitmq-operator/.github 目录，此目录是官方 github action 部分的代码，对其他项目无用（也可以不删除） 在 rabbitmq-operator/internal/resource 目录新建 anyuid_role_binding.go 文件，将下面代码复制到文件中，代码是根据 role_binding.go 文件修改来的，目的是解决 openshift scc 权限问题  // RabbitMQ Cluster Operator // // Copyright 2020 VMware, Inc."><meta itemprop=datePublished content="2021-04-20T09:24:32+08:00"><meta itemprop=dateModified content="2021-04-20T09:24:32+08:00"><meta itemprop=wordCount content="469"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Make Rabbitmq Openshift Operator"><meta name=twitter:description content="制作 rabbitmq openshift operator  以 rabbitmq-operator github 官方项目为基础 https://github.com/rabbitmq/cluster-operator  命令行工具  kustomize   下载地址
 operator-sdk   下载地址
 opm   下载地址
 制作过程  本文档以 rabbitmq 1.6.0 为基础制作 operator，link   下载源码  从官方 releases 页面下载 1.6.0 源码 解压后改名为 rabbitmq-operator  修改部分源码  删除 rabbitmq-operator/.github 目录，此目录是官方 github action 部分的代码，对其他项目无用（也可以不删除） 在 rabbitmq-operator/internal/resource 目录新建 anyuid_role_binding.go 文件，将下面代码复制到文件中，代码是根据 role_binding.go 文件修改来的，目的是解决 openshift scc 权限问题  // RabbitMQ Cluster Operator // // Copyright 2020 VMware, Inc."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">打工人，冲冲冲！！！</a><div class="flex-l items-center"><a href=https://github.com/Hair1ossTeenager target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://www.changkunkun.cn/posts/make-rabbitmq-openshift-operator/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://www.changkunkun.cn/posts/make-rabbitmq-openshift-operator/&text=Make%20Rabbitmq%20Openshift%20Operator" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.changkunkun.cn/posts/make-rabbitmq-openshift-operator/&title=Make%20Rabbitmq%20Openshift%20Operator" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Make Rabbitmq Openshift Operator</h1><time class="f6 mv4 dib tracked" datetime=2021-04-20T09:24:32+08:00>April 20, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h3 id=制作-rabbitmq-openshift-operator>制作 rabbitmq openshift operator</h3><ul><li>以 rabbitmq-operator github 官方项目为基础</li><li><a href=https://github.com/rabbitmq/cluster-operator>https://github.com/rabbitmq/cluster-operator</a></li></ul><h3 id=命令行工具>命令行工具</h3><ol><li>kustomize</li></ol><blockquote><p><a href=https://github.com/kubernetes-sigs/kustomize/releases>下载地址</a></p></blockquote><ol start=2><li>operator-sdk</li></ol><blockquote><p><a href=https://github.com/operator-framework/operator-sdk/releases>下载地址</a></p></blockquote><ol start=3><li>opm</li></ol><blockquote><p><a href=https://github.com/operator-framework/operator-registry/releases>下载地址</a></p></blockquote><h3 id=制作过程>制作过程</h3><ul><li>本文档以 rabbitmq 1.6.0 为基础制作 operator，<a href=https://github.com/rabbitmq/cluster-operator/tree/v1.6.0>link</a></li></ul><hr><h4 id=下载源码>下载源码</h4><ol><li>从官方 releases 页面下载 1.6.0 源码</li><li>解压后改名为 rabbitmq-operator</li></ol><h4 id=修改部分源码>修改部分源码</h4><ol><li>删除 rabbitmq-operator/.github 目录，此目录是官方 github action 部分的代码，对其他项目无用（也可以不删除）</li><li>在 rabbitmq-operator/internal/resource 目录新建 anyuid_role_binding.go 文件，将下面代码复制到文件中，代码是根据 role_binding.go 文件修改来的，目的是解决 openshift scc 权限问题</li></ol><pre><code>// RabbitMQ Cluster Operator
//
// Copyright 2020 VMware, Inc. All Rights Reserved.
//
// This product is licensed to you under the Mozilla Public license, Version 2.0 (the &quot;License&quot;).  You may not use this product except in compliance with the Mozilla Public License.
//
// This product may include a number of subcomponents with separate copyright notices and license terms. Your use of these subcomponents is subject to the terms and conditions of the subcomponent's license, as noted in the LICENSE file.
//

package resource

import (
	&quot;fmt&quot;
	rbacv1 &quot;k8s.io/api/rbac/v1&quot;
	metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;
	&quot;k8s.io/apimachinery/pkg/runtime&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;
	&quot;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&quot;

	rabbitmqv1beta1 &quot;github.com/rabbitmq/cluster-operator/api/v1beta1&quot;
	&quot;github.com/rabbitmq/cluster-operator/internal/metadata&quot;
)

const (
	anyuidRoleBindingName = &quot;anyuid&quot;
)

type AnyuidRoleBindingBuilder struct {
	Instance *rabbitmqv1beta1.RabbitmqCluster
	Scheme   *runtime.Scheme
}

func (builder *RabbitmqResourceBuilder) AnyuidRoleBinding () *AnyuidRoleBindingBuilder {
	return &amp;AnyuidRoleBindingBuilder{
		Instance: builder.Instance,
		Scheme:   builder.Scheme,
	}
}

func (builder *AnyuidRoleBindingBuilder) UpdateMayRequireStsRecreate() bool {
	return false
}

func (builder *AnyuidRoleBindingBuilder) Update(object client.Object) error {
	roleBinding := object.(*rbacv1.RoleBinding)
	roleBinding.Labels = metadata.GetLabels(builder.Instance.Name, builder.Instance.Labels)
	roleBinding.Annotations = metadata.ReconcileAndFilterAnnotations(roleBinding.GetAnnotations(), builder.Instance.Annotations)
	roleBinding.RoleRef = rbacv1.RoleRef{
		APIGroup: &quot;rbac.authorization.k8s.io&quot;,
		Kind:     &quot;ClusterRole&quot;,
		Name:     &quot;system:openshift:scc:anyuid&quot;,
	}
	roleBinding.Subjects = []rbacv1.Subject{
		{
			Kind: &quot;ServiceAccount&quot;,
			Name: builder.Instance.ChildResourceName(serviceAccountName),
		},
	}

	if err := controllerutil.SetControllerReference(builder.Instance, roleBinding, builder.Scheme); err != nil {
		return fmt.Errorf(&quot;failed setting controller reference: %v&quot;, err)
	}
	return nil
}

func (builder *AnyuidRoleBindingBuilder) Build() (client.Object, error) {
	return &amp;rbacv1.RoleBinding{
		ObjectMeta: metav1.ObjectMeta{
			Namespace: builder.Instance.Namespace,
			Name:      builder.Instance.ChildResourceName(anyuidRoleBindingName),
		},
	}, nil
}
</code></pre><ol start=3><li>在 rabbitmq-operator/internal/resource/rabbitmq_resource_builder.go 文件第 39 行下添加以下代码</li></ol><pre><code>builder.AnyuidRoleBinding(),
</code></pre><ol start=4><li>修改 rabbitmq-operator/Dockerfile 第 9 行，修改代理，解决国内下载依赖网络问题</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>RUN go env -w GOPROXY<span style=color:#f92672>=</span>https://goproxy.cn <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> go mod download
</code></pre></div><ol start=5><li>将 rabbitmq operator controller 重新构建上传至镜像仓库</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker build -t harbor.test.geely.com/operator/rabbitmq-operator-controller:base .
docker push harbor.test.geely.com/operator/rabbitmq-operator-controller:base
</code></pre></div><h4 id=使用命令行工具生产文件>使用命令行工具生产文件</h4><ol><li>生成 csv manifests，按照提示输入 operator 描述信息和提供者信息</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>operator-sdk generate kustomize manifests
</code></pre></div><ol start=2><li>修改 rabbitmq-operator/config/manager/kustomization.yaml 文件最后两行，修改为上面 controller 的镜像和 tag</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml> <span style=color:#f92672>newName</span>: <span style=color:#ae81ff>harbor.test.geely.com/operator/rabbitmq-operator-controller</span>
 <span style=color:#f92672>newTag</span>: <span style=color:#ae81ff>base</span>
</code></pre></div><ol start=3><li>修改 rabbitmq-operator/config/manifests/kustomization.yaml 为</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>resources</span>:
- <span style=color:#ae81ff>../samples/base</span>
- <span style=color:#ae81ff>../installation</span>
</code></pre></div><ol start=4><li>修改 rabbitmq-operator/config/manifests/bases/rabbitmq-operator.clusterserviceversion.yaml</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 第 15 行修改为 icon 文件 base64 encode 的值，第 16 行为 icon 文件格式</span>
- <span style=color:#f92672>base64data</span>: <span style=color:#e6db74>&#34;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&#34;</span>
  <span style=color:#f92672>mediatype</span>: <span style=color:#e6db74>&#34;image/png&#34;</span>
<span style=color:#75715e># 第 22，24，26，28 行修改为 true </span>
- <span style=color:#f92672>supported</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><ol start=5><li>生成 csv 文件，会放在 rabbitmq-operator/bundle 目录下，bundle.Dockerfile 文件放在 rabbitmq-operator 目录下</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kustomize build config/manifests | operator-sdk generate bundle --package rabbitmq-operator --version 1.6.0
</code></pre></div><ol start=6><li>验证 csv 文件</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>operator-sdk bundle validate ./bundle
</code></pre></div><ol start=7><li>打包上传 csv 文件镜像到镜像仓库</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker build -f bundle.Dockerfile -t harbor.test.geely.com/operator/rabbitmq-operator:v1.6.0 .
docker push harbor.test.geely.com/operator/rabbitmq-operator:v1.6.0
</code></pre></div><ol start=8><li>检查编译的镜像是正确</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opm alpha bundle validate --tag harbor.test.geely.com/operator/rabbitmq-operator:v1.6.0 --image-builder docker
</code></pre></div><ol start=9><li>使用opm 命令将csv 镜像内容打包到 opm index 镜像中，并上传到镜像仓库</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opm index add -b harbor.test.geely.com/operator/rabbitmq-operator:v2.6.0 -t harbor.test.geely.com/operator/geely-index:v1 -u docker
docker push harbor.test.geely.com/operator/geely-index:v1
</code></pre></div><ol start=10><li>创建自定义 catalog 源</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat <span style=color:#e6db74>&lt;&lt; EOF | oc create -f -
</span><span style=color:#e6db74>apiVersion: operators.coreos.com/v1alpha1
</span><span style=color:#e6db74>kind: CatalogSource
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: geely-catalog
</span><span style=color:#e6db74>  namespace: openshift-marketplace
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  displayName: geely-catalog
</span><span style=color:#e6db74>  image: harbor.test.geely.com/operator/geely-index:v1
</span><span style=color:#e6db74>  publisher: geely
</span><span style=color:#e6db74>  sourceType: grpc 
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><ol start=11><li>安装 operator 到 openshift-operators namespace 下，并对 sa rabbitmq-cluster-operator 添加 scc anyuid 权限</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>oc adm policy add-scc-to-user anyuid -z rabbitmq-cluster-operator
</code></pre></div><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.changkunkun.cn>&copy; 打工人，冲冲冲！！！ 2021</a><div><a href=https://github.com/Hair1ossTeenager target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer></body></html>